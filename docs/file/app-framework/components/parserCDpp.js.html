<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">app-framework/components/parserCDpp.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-custom.css"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#base">base</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/application.js~Application.html">Application</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/evented.js~Evented.html">Evented</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/list.js~List.html">List</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/nls.js~Nls.html">Nls</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/template.js~Template.html">Template</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/base/widget.js~Widget.html">Widget</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/automator.js~Automator.html">Automator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/chunk-reader.js~Reader.html">Reader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/config.js~Config.html">Config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/parserCDpp.js~ParserCDpp.html">ParserCDpp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/recorder.js~Recorder.html">Recorder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/styler.js~Styler.html">Styler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-ol">components/ol</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/ol/legend.js~Legend.html">Legend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/ol/map.js~Map.html">Map</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components-style">components/style</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/bucketFill.js~BucketFill.html">BucketFill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/bucketRadius.js~BucketRadius.html">BucketRadius</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/bucketScale.js~BucketScale.html">BucketScale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/bucketStroke.js~BucketStroke.html">BucketStroke</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/linestring.js~Linestring.html">Linestring</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/point.js~Point.html">Point</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/pointIcon.js~PointIcon.html">PointIcon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/polygon.js~Polygon.html">Polygon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/staticFill.js~StaticFill.html">StaticFill</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/staticRadius.js~StaticRadius.html">StaticRadius</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/staticScale.js~StaticScale.html">StaticScale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/components/style/staticStroke.js~StaticStroke.html">StaticStroke</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-structures-configuration">data_structures/configuration</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/configuration.js~Configuration.html">Configuration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/diagram.js~Diagram.html">Diagram</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/gis.js~GIS.html">GIS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/grid.js~Grid.html">Grid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/playback.js~Playback.html">Playback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/configuration/section.js~Section.html">Section</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-structures-metadata">data_structures/metadata</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/info.js~Info.html">Info</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/link.js~Link.html">Link</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/message_type.js~MessageType.html">MessageType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/metadata.js~Metadata.html">Metadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/model_ca.js~ModelCA.html">ModelCA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/structure.js~Structure.html">Structure</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/type.js~Type.html">Type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/type_model.js~TypeModel.html">TypeModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/type_model_ca.js~TypeModelCA.html">TypeModelCA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/metadata/type_port.js~TypePort.html">TypePort</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-structures-simulation">data_structures/simulation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/cache.js~Cache.html">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/frame.js~Frame.html">Frame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/message.js~Message.html">Message</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/message_output.js~MessageOutput.html">MessageOutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/message_state.js~MessageState.html">MessageState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/message_state_ca.js~MessageStateCA.html">MessageStateCA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/simulation.js~Simulation.html">Simulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/simulation_ca.js~SimulationCA.html">SimulationCA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/simulation_devs.js~SimulationDEVS.html">SimulationDEVS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/state.js~State.html">State</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/stateCA.js~StateCA.html">StateCA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/data_structures/simulation/stateDEVS.js~StateDEVS.html">StateDEVS</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#tools">tools</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/tools/core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/tools/dom.js~Dom.html">Dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/tools/net.js~Net.html">Net</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/tools/style.js~Style.html">Style</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/tools/zip.js~Zip.html">Zip</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui">ui</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/box-input-files.js~BoxInputFiles.html">BoxInputFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/list.js~List.html">List</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/picker.js~Picker.html">Picker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/popup.js~Popup.html">Popup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/select.js~Select.html">Select</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/tooltip.js~Tooltip.html">Tooltip</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app-framework/ui/yes-no.js~YesNo.html">YesNo</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app-framework/components/parserCDpp.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import Core from &apos;../tools/core.js&apos;;
import Evented from &quot;../base/evented.js&quot;;
import Reader from &quot;../components/chunk-reader.js&quot;;
import List from &quot;../base/list.js&quot;;
import Configuration from &apos;../data_structures/configuration/configuration.js&apos;;
import SimulationCA from &quot;../data_structures/simulation/simulation_ca.js&quot;;
import Frame from &quot;../data_structures/simulation/frame.js&quot;;
import MessageStateCA from &quot;../data_structures/simulation/message_state_ca.js&quot;
import TypeModelCA from &apos;../data_structures/metadata/type_model_ca.js&apos;;
import TypePort from &apos;../data_structures/metadata/type_port.js&apos;;
import ModelCA from &apos;../data_structures/metadata/model_ca.js&apos;;
import MessageType from &apos;../data_structures/metadata/message_type.js&apos;;
import Structure from &quot;../data_structures/metadata/structure.js&quot;;
import Info from &quot;../data_structures/metadata/info.js&quot;;

/**
 * A parser component to process the raw Cell-DEVS results from CDpp or Lopez
 */
export default class ParserCDpp extends Evented { 
	
	constructor() {
		super();
		
		this.initialValue = null;
		this.initialRowValues = null;
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses a component token from the ma file into a structure model. 
	 * @param {Structure} structure - the simulation structure
	 * @param {string} name  - the name of the model
	 * @param {string} type - the type of the model
	 * @return {Model} the model created
	 */	
	make_component(structure, name, type) {
		var msg_type_id = structure.message_types.length;
		var model_type_id = structure.model_types.length;
		
		var msg_type = new MessageType(msg_type_id, `s_${name}`, [&quot;out&quot;], &quot;No description available.&quot;);
		var port = new TypePort(&quot;out&quot;, &quot;output&quot;, null);
		var model_type = new TypeModelCA(model_type_id, name, type, msg_type, [port], null, null, null)
		var model = new ModelCA(name, model_type, null);
		
		structure.message_types.push(msg_type);
		structure.model_types.push(model_type);
		
		structure.add_model(model);
				
		return model;
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the *.ma file into a Structure object
	 * @param {File} ma - the *.ma file
	 * @return {Structure} the structure object built from the file
	 */		
	async parse_structure(ma) {	
		var s = new Structure(new Info(&quot;top&quot;, &quot;CDpp&quot;, &quot;Cell-DEVS&quot;));	
		
		var id = 0;
		var content = await Reader.read_as_text(ma); 
		var lines = content.split(&quot;\n&quot;);
		var curr = null;

		for (var i = 0; i&#xA0;&lt;&#xA0;lines.length; i++) {
			var l = lines[i].trim();
			
			if (l.startsWith(&quot;[&quot;)) {		
				var name = l.substring(1, l.length - 1);
				
				if (name.toLowerCase() == &quot;top&quot;) this.make_component(s, name, &quot;coupled&quot;);
				
				curr = s.model_types.find(m =&gt; m.name == name);
			}
			
			else if (curr == null ||&#xA0;l.startsWith(&apos;%&apos;) ||&#xA0;!l.includes(&quot;:&quot;)) continue;
			
			else {
				var kv = l.split(&apos;:&apos;).map(l =&gt; l.trim());
				
				kv[0] = kv[0].toLowerCase();
				
				if (kv[0] == &quot;components&quot;) {				
					var model = this.make_component(s, kv[1].split(&apos; &apos;)[0].trim(), &quot;atomic&quot;);
					
					curr.add_submodel(model); 
				}
				
				else if (kv[0] == &quot;dim&quot;) {
					curr.dim = kv[1].substring(1, kv[1].length - 1).split(&quot;,&quot;).map(c =&gt;&#xA0;+c.trim());
				
					if (curr.dim.length == 2) curr.dim.push(1);
				}
				
				else if (kv[0] == &quot;height&quot;) {
					if (!curr.dim) curr.dim = [0, +kv[1], 1];
					
					else curr.dim[1] = +kv[1];
				}
				
				else if (kv[0] == &quot;width&quot;) {
					if (!curr.dim) curr.dim = [+kv[1], 0, 1];
					
					else curr.dim[0] = +kv[1];
				}
				
				else if (kv[0] == &quot;neighborports&quot;) {
					var ports = kv[1].split(&quot; &quot;).map(c =&gt;&#xA0;c.trim());
				
					ports.forEach(p =&gt; {
						curr.add_port(new TypePort(`out_${p}`, &quot;output&quot;, null));
						curr.template.push(`out_${p}`);
					});
				}
				
				else if (kv[0] == &quot;initialvalue&quot;) this.initialValue = kv[1];

				else if (kv[0] == &quot;initialrowvalue&quot;) {
					if (this.initialRowValues == null) this.initialRowValues = [];
					
					var lr = kv[1].replace(/\s\s+/g, &apos;,&apos;).split(&apos;,&apos;);
					
					this.initialRowValues.push({
						row: +lr[0],
						values: lr[1].split(&apos;&apos;)
					});
				}

			}
		}
		
		return s;
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the *.pal file
	 * @param {File} pal - the *.pal file
	 * @return {object} the style object
	 */	
	async parse_palette(pal) {
		var content = await Reader.read_as_text(pal);		
		var lines = content.trim().split(&quot;\n&quot;).map(l =&gt; l.trim());
		var style = { buckets: [] };
		
		// VALIDSAVEDFILE
		// 169,169,169
		// ...
		// 4.0,4.9
		if (lines[0] == &quot;VALIDSAVEDFILE&quot;) {
			var j = 0;
			
			for (var i = 1; i&#xA0;&lt;&#xA0;lines.length; i++) {
				var split = lines[i].split(&apos;,&apos;).map(l =&gt; +l.trim());
				
				if (split.length == 3) {
					style.buckets.push({ start:null, end:null, color:split });
				}

				else {
					style.buckets[j].start = split[0];
					style.buckets[j++].end = split[1];
				}
			}
		}
		
        // [-0.1;0.9] 255 255 51
        // [-1.1;-0.9] 153 255 255
        // ...
		else {
			for (var i = 0; i&#xA0;&lt;&#xA0;lines.length; i++) {
				split = lines[i].replace(&apos;[&apos;,&apos;&apos;)
								.replace(&apos;]&apos;,&apos;&apos;)
								.replace(&apos;;&apos;,&apos; &apos;)
								.replaceAll(&apos;,&apos;,&apos;&apos;)
								.split(&apos; &apos;).map(s =&gt; +s);

				style.buckets.push({ start:split[0], end:split[1], color:[split[2], split[3], split[4]] });
			}
		}
		
		return [style];
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the initialrowvalues token in the ma file. 
	 * Adds corresponding messages to the frame 0.
	 * @param {Frame[]} frames - the simulation frames
	 * @param {string} t0  - the time 0 (i.e. 00:00:000)
	 * @param {Model} model - the top model of the simulation 
	 */	
	read_initial_row_values(frames, t0, model) {
		if (this.initialRowValues == null) return;
		
		var f0 = frames.get(t0) || frames.add(new Frame(t0));
		
		this.initialRowValues.forEach(irv =&gt;&#xA0;{
			irv.values.forEach((v, y) =&gt;&#xA0;{
				var coord = [irv.row, +y, 0]
				var value = model.template.map(t =&gt; v);
				
				f0.add_state_message(new MessageStateCA(coord, value));
			});
		});
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the initialvalues token in the ma file. 
	 * Adds corresponding messages to the frame 0.
	 * @param {Frame[]} frames - the simulation frames
	 * @param {string} t0  - the time 0 (i.e. 00:00:000)
	 * @param {Model} model - the top model of the simulation 
	 * @param {number[]} dim - the dimensions of the cell-space
	 */	
	read_initial_value(frames, t0, model, dim) {
		if (this.initialValue == null) return;
		
		var f0 = frames.get(t0) || frames.add(new Frame(t0));
		
        for (var x = 0; x &lt;&#xA0;model.dim[0]; x++) {
            for (var y = 0; y &lt; model.dim[1]; y++) {
                for (var z = 0; z &lt; model.dim[2]; z++) {
					var coord = [x, y, z];
					var value = model.template.map(t =&gt; this.initialValue);
					
					f0.add_state_message(new MessageStateCA(coord, value));
				}
			}
		}		
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the *.val file. Adds corresponding messages to the frame 0.
	 * @param {Frame[]} frames - the simulation frames
	 * @param {string} t0  - the time 0 (i.e. 00:00:000)
	 * @param {File} val - the *.val file
	 */	
	async read_val(frames, t0, val) {
		if (!val) return;
		
		var f0 = frames.get(t0) || frames.add(new Frame(t0));
		var content = await Reader.read_as_text(val);		
		var lines = content.trim().split(&quot;\n&quot;).map(l =&gt; l.trim());
		
        // (0,0,0)=100 2 1
        // (0,0,1)=0.567 0 1
        // ...
		for (var i = 0; i&#xA0;&lt;&#xA0;lines.length; i++) {
			var split = lines[i].split(&apos;=&apos;).map(l =&gt; l.trim()); 
			
			if (split.length != 2) continue;
			
			var coord = split[0].substring(1, split[0].length - 1).split(&quot;,&quot;).map(s =&gt;&#xA0;s.trim());
			var value = split[1].split(&quot; &quot;).map(v =&gt;&#xA0;v.trim());
			
			if (coord.length  == 2) coord.push(&quot;0&quot;);
			
			f0.add_state_message(new MessageStateCA(coord, value));
		}
	}
	
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the *.map file. Adds corresponding messages to the frame 0.
	 * @param {Frame[]} frames - the simulation frames
	 * @param {string} t0  - the time 0 (i.e. 00:00:000)
	 * @param {Model} model - the top model of the simulation 
	 * @param {File} map - the *.map file
	 */	
	async read_map(frames, t0, model, map) {
		if (!map) return;
		
		var f0 = frames.get(t0) || frames.add(new Frame(t0));
		var content = await Reader.read_as_text(map);
		var lines = content.trim().split(&quot;\n&quot;).map(l =&gt; l.trim());		
		var i = 0;
		
		for (var x = 0; x &lt;&#xA0;model.dim[0]; x++) {
			for (var y = 0; y &lt;&#xA0;model.dim[1]; y++) {
				for (var z = 0; z &lt;&#xA0;model.dim[2]; z++) {
					if (i == lines.length) throw new Error(&quot;missing initial values in map file.&quot;); 
											
					f0.add_state_message(new MessageStateCA([x, y, z], lines[i++].trim()));
				}
			}
		}
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses the *val, *map and *.log file
	 * @param {Structure} structure - the structure object for a simulation
	 * @param {File} log - the *.log file
	 * @param {File} val - the *.val file
	 * @param {File} map - the *.map file
	 * @return {Frame[]} an array of frames built from the messages.log
	 */	
	async parse_messages(structure, log, val, map) {
		var lopez_test = await log.slice(0, 5).text();
		var is_lopez = lopez_test == &quot;0 / L&quot;;
		var t0 = is_lopez ? &quot;00:00:00:000:0&quot; : &quot;00:00:00:000&quot;;
		
		var model = structure.model_types[1];
		var frames = new List(f =&gt; f.time);
		
		if (!is_lopez) this.read_initial_value(frames, t0, model);
		if (!is_lopez) this.read_initial_row_values(frames, t0, model);
		
		await this.read_val(frames, t0, val);
		await this.read_map(frames, t0, model, map);
		
		await Reader.read_by_chunk(log, &quot;\n&quot;, (parsed, chunk, progress) =&gt; {			
			var lines = chunk.split(&quot;\n&quot;);
			
			for (var i = 0; i&#xA0;&lt;&#xA0;lines.length; i++) {
				var line = lines[i];
				
				// Mensaje Y / 00:00:00:100 / flu(18,12)(645) / out /      2.00000 para flu(02)
				// Mensaje Y / 00:00:20:000 / sender(02) / dataout /     11.00000 para top(01)
				if (line.startsWith(&quot;Mensaje Y&quot;)) this.parse_cdpp_line(frames, line);
				
				else if (line.startsWith(&quot;0 / L / Y&quot;)) this.parse_lopez_line(frames, model, line);
			}
			
			this.emit(&quot;progress&quot;, { progress: progress });
		});
		
		frames.forEach(f =&gt; {
			f.state_messages.forEach(m =&gt; {
				m.value = model.apply_template(m.value);
			});
		});
		
		return frames;
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses a CDpp line from the *.log. Adds it to the frame provided.
	 * @param {Frame[]} frames - a time frame for the simulation
	 * @param {string} line - a line from the *.log
	 */	
	parse_cdpp_line(frames, line) {
		var split = line.split(&apos;/&apos;).map(l =&gt; l.trim());
		var model = split[2].replaceAll(&apos;(&apos;, &apos; &apos;).replaceAll(&apos;)&apos;, &apos;&apos;).split(&apos; &apos;)
		var coord = model.length == 3 ? model[1].split(&apos;,&apos;) : null;
		
		var time = split[1]
		var port = split[3]
		var value = split[4].split(&apos; &apos;)[0]
		
		var frame = frames.get(time) || frames.add(new Frame(time));

		if (coord) {
			if (coord.length == 2) coord.push(&quot;0&quot;);
						
			frame.add_state_message(new MessageStateCA(coord, [value]));
		}
	}
	
	/**                          &#xA0;&#xA0;&#xA0;&#xA0;
	 * Parses a Lopez line from the *.log. Adds it to the frame provided.
	 * @param {Frame[]} frames - a time frame for the simulation
	 * @param {TypeModel} model_type - the TypeModel of the top model
	 * @param {string} line - a line from the *.log
	 */	
	parse_lopez_line(frames, model_type, line) {
		var split = line.split(&apos;/&apos;).map(l =&gt; l.trim());
		var model = split[4].replaceAll(&apos;(&apos;, &apos; &apos;).replaceAll(&apos;)&apos;, &apos;&apos;).split(&apos; &apos;)
		var c = model.length == 3 ? model[1].split(&apos;,&apos;) : null;
		
		var time = split[3]
		var port = split[5]
		var value = split[6]
		
		var frame = frames.get(time) || frames.add(new Frame(time));

		if (c) {
			if (c.length == 2) c.push(&quot;0&quot;);
			
			var m = frame.state_messages.find(m =&gt; m.x == c[0] &amp;&amp; m.y == c[1] &amp;&amp; m.z == c[2])

			if (!m) {
				var values = model_type.template.map(t =&gt; &quot;&quot;);
				
				m = frame.add_state_message(new MessageStateCA(c, values));
			}
			
			var idx = model_type.ports.findIndex(p =&gt; p.name == port);
			
			m.value[idx] = value;
		}
	}
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
